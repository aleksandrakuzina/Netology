### Задача 1
В этом задании вы потренируетесь в:

    установке elasticsearch
    первоначальном конфигурировании elastcisearch
    запуске elasticsearch в docker

Используя докер образ `centos:7` как базовый и документацию по установке и запуску `Elasticsearch`:

* dockerfile
````
root@vagrant:/home/vagrant/elasticsearch# cat dockerfile
FROM centos:7
RUN adduser -mr elastic && mkdir /var/lib/elastic && chown elastic /var/lib/elastic
USER elastic
RUN cd && curl https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.1-linux-x86_64.tar.gz --output elasticsearch-8.1.1-linux-x86_64.tar.gz && tar -xzf elasticsearch-8.1.1-linux-x86_64.tar.gz && rm elasticsearch-8.1.1-linux-x86_64.tar.gz && cd elasticsearch-8.1.1/ && echo "node.name: netology_test" >> config/elasticsearch.yml && echo "path.data: /var/lib/elastic" >> config/elasticsearch.yml
EXPOSE 9200
CMD $HOME/elasticsearch-8.1.1/bin/elasticsearch
````

* docker build .
````
root@vagrant:/home/vagrant/elasticsearch# docker build .
Sending build context to Docker daemon  1.617GB
Step 1/6 : FROM centos:7
7: Pulling from library/centos
2d473b07cdd5: Pull complete
Digest: sha256:c73f515d06b0fa07bb18d8202035e739a494ce760aa73129f60f4bf2bd22b407
Status: Downloaded newer image for centos:7
 ---> eeb6ee3f44bd
Step 2/6 : RUN adduser -mr elastic && mkdir /var/lib/elastic && chown elastic /var/lib/elastic
 ---> Running in b458fa0acc7f
Removing intermediate container b458fa0acc7f
 ---> fb3b78ea6b34
Step 3/6 : USER elastic
 ---> Running in 7a95a17b7415
Removing intermediate container 7a95a17b7415
 ---> f6f8a9254f94
Step 4/6 : RUN cd && curl https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.1-linux-x86_64.tar.gz --output elasticsearch-8.1.1-linux-x86_64.tar.gz && tar -xzf elasticsearch-8.1.1-linux-x86_64.tar.gz && rm elasticsearch-8.1.1-linux-x86_64.tar.gz && cd elasticsearch-8.1.1/ && echo "node.name: netology_test" >> config/elasticsearch.yml && echo "path.data: /var/lib/elastic" >> config/elasticsearch.yml
 ---> Running in 3a6bfc2515f9
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  491M  100  491M    0     0  6728k      0  0:01:14  0:01:14 --:--:-- 6864k
Removing intermediate container 3a6bfc2515f9
 ---> 1ee54fb30cd3
Step 5/6 : EXPOSE 9200
 ---> Running in f00ca4ca9bea
Removing intermediate container f00ca4ca9bea
 ---> d696dd0b399d
Step 6/6 : CMD $HOME/elasticsearch-8.1.1/bin/elasticsearch
 ---> Running in 2cd8200ecf86
Removing intermediate container 2cd8200ecf86
 ---> 93a4ba9d7980
Successfully built 93a4ba9d7980
````

* Запуск контейнера и просмотр его статуса
````
root@vagrant:/home/vagrant/elasticsearch# docker run -dp 9200:9200 93a4ba9d7980
20f6a0aa0c76085b96b30ff4c16cf368cec12a3a0d66cf29f11e789f2fbf751b

root@vagrant:/home/vagrant/elasticsearch# docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                                       NAMES
20f6a0aa0c76   93a4ba9d7980   "/bin/sh -c $HOME/el…"   5 seconds ago   Up 4 seconds   0.0.0.0:9200->9200/tcp, :::9200->9200/tcp   reverent_wozniak
````

* Смена пароля
````
root@vagrant:/home/vagrant/elasticsearch# docker exec -it reverent_wozniak /home/elastic/elasticsearch-8.1.1/bin/elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: 0YeC8hB6t+F1INswDmqh
````

* Проверка подключения через `curl`
````
root@vagrant:/home/vagrant# curl -ku elastic https://localhost:9200
Enter host password for user 'elastic':
{
  "name" : "netology_test",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "_nPWyGVnSamDcHnukZ6d4w",
  "version" : {
    "number" : "8.1.1",
    "build_flavor" : "default",
    "build_type" : "tar",
    "build_hash" : "d0925dd6f22e07b935750420a3155db6e5c58381",
    "build_date" : "2022-03-17T22:01:32.658689558Z",
    "build_snapshot" : false,
    "lucene_version" : "9.0.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
````

* Создание тэга, авторизация и пуш образа
````
root@vagrant:/home/vagrant# docker tag 93a4ba9d7980 alleksandra/6.5
root@vagrant:/home/vagrant# docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.
Username: alleksandra
Password:
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
root@vagrant:/home/vagrant# docker push alleksandra/6.5
Using default tag: latest
The push refers to repository [docker.io/alleksandra/6.5]
d103e5d2665b: Pushed
6282ae7f6366: Pushed
174f56854903: Mounted from library/centos
latest: digest: sha256:00821e8322f15873c3d9d77b3c35f580c1188e8240a048a5184d629111220260 size: 950
````
* [Ссылка на репозиторий](https://hub.docker.com/repository/docker/alleksandra/6.5)

### Задача 2

В этом задании вы научитесь:

    создавать и удалять индексы
    изучать состояние кластера
    обосновывать причину деградации доступности данных

Ознакомьтесь с документацией и добавьте в `elasticsearch` 3 индекса, в соответствии с таблицей:

    |  Имя  | Количество реплик | Количество шард |
    |-------|-------------------|-----------------|
    | ind-1 |         0         |        1        |
    | ind-2 |         1         |        2        |
    | ind-3 |         2         |        4        |

* ind-1

````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT "https://localhost:9200/ind-1" -H 'Content-Type: application/json' -d'
> {
>   "settings": {
>     "index": {
>       "number_of_shards": 1,
>       "number_of_replicas": 0
>     }
>   }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-1"}
````

* ind-2

````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT "https://localhost:9200/ind-2" -H 'Content-Type: application/json' -d'
> {
>   "settings": {
>     "index": {
>       "number_of_shards": 2,
>       "number_of_replicas": 1
>     }
>   }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-2"}
````

* ind-3

````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT "https://localhost:9200/ind-3" -H 'Content-Type: application/json' -d'
> {
>   "settings": {
>     "index": {
>       "number_of_shards": 4,
>       "number_of_replicas": 2
>     }
>   }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-3"}
````

Получите список индексов и их статусов, используя API и приведите в ответе на задание.
````
root@vagrant:/home/vagrant# curl -ku elastic https://localhost:9200/_cat/indices
Enter host password for user 'elastic':
green  open ind-1 YNWWvyZASrS0Uq3KfQIoOg 1 0 0 0 225b 225b
yellow open ind-3 ZZH6MJMoS2-oVdgwehtXOA 4 2 0 0 900b 900b
yellow open ind-2 oH2POkH3QHa5qgq1ALc-RA 2 1 0 0 450b 450b
````

Получите состояние кластера `elasticsearch`, используя API.
````
root@vagrant:/home/vagrant# curl -ku elastic https://localhost:9200/_cluster/health?pretty
Enter host password for user 'elastic':
{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 9,
  "active_shards" : 9,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 10,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 47.368421052631575
}
````

Как вы думаете, почему часть индексов и кластер находится в состоянии `yellow`?

````
"Yellow" индексы созданы с количеством реплик и шард больше имеющихся. Кластер в состоянии "yellow" потому, что количество unassigned_shards > 0.
````

Удалите все индексы.

````
root@vagrant:/home/vagrant# curl -ku elastic -X DELETE https://localhost:9200/ind-1
Enter host password for user 'elastic':
{"acknowledged":true}
root@vagrant:/home/vagrant# curl -ku elastic -X DELETE https://localhost:9200/ind-2
Enter host password for user 'elastic':
{"acknowledged":true}
root@vagrant:/home/vagrant# curl -ku elastic -X DELETE https://localhost:9200/ind-3
Enter host password for user 'elastic':
{"acknowledged":true}
````

### Задача 3

В данном задании вы научитесь:

    создавать бэкапы данных
    восстанавливать индексы из бэкапов

Создайте директорию `{путь до корневой директории с elasticsearch в образе}/snapshots`.
````
root@vagrant:/home/vagrant# docker exec -it reverent_wozniak mkdir /home/elastic/elasticsearch-8.1.1/snapshots
````

Используя API зарегистрируйте данную директорию как `snapshot repository` c именем `netology_backup`.
````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT "https://localhost:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d' { "type": "fs", "settings": { "location": "/home/elastic/elasticsearch-8.1.1/snapshots" } } '
Enter host password for user 'elastic':
{
  "error" : {
    "root_cause" : [
      {
        "type" : "repository_exception",
        "reason" : "[netology_backup] location [/home/elastic/elasticsearch-8.1.1/snapshots] doesn't match any of the locations specified by path.repo because this setting is empty"
      }
    ],
    "type" : "repository_exception",
    "reason" : "[netology_backup] failed to create repository",
    "caused_by" : {
      "type" : "repository_exception",
      "reason" : "[netology_backup] location [/home/elastic/elasticsearch-8.1.1/snapshots] doesn't match any of the locations specified by path.repo because this setting is empty"
    }
  },
  "status" : 500
}
````

Приведите в ответе запрос API и результат вызова API для создания репозитория.

* Разместим каталог снапшотов в `/var/lib/elastic/snapshots`, скорректируем Dockerfile и пересоберём образ:
````
root@vagrant:/home/vagrant/elasticsearch# cat dockerfile
FROM centos:7
RUN adduser -mr elastic && mkdir -p /var/lib/elastic/snapshots && chown -R elastic /var/lib/elastic/snapshots
USER elastic
RUN cd && curl https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.1-linux-x86_64.tar.gz --output elasticsearch-8.1.1-linux-x86_64.tar.gz && tar -xzf elasticsearch-8.1.1-linux-x86_64.tar.gz && rm elasticsearch-8.1.1-linux-x86_64.tar.gz && cd elasticsearch-8.1.1/ && echo "node.name: netology_test" >> config/elasticsearch.yml && echo "path.repo: /var/lib/elastic/snapshots" >> config/elasticsearch.yml
EXPOSE 9200
CMD $HOME/elasticsearch-8.1.1/bin/elasticsearch
````

* Соберём образ
````
root@vagrant:/home/vagrant/elasticsearch# docker build .
Sending build context to Docker daemon  515.8MB
Step 1/6 : FROM centos:7
 ---> eeb6ee3f44bd
Step 2/6 : RUN adduser -mr elastic && mkdir -p /var/lib/elastic/snapshots && chown -R elastic /var/lib/elastic/snapshots
 ---> Running in 6d4c84bc1a5a
Removing intermediate container 6d4c84bc1a5a
 ---> 5d21f827b26c
Step 3/6 : USER elastic
 ---> Running in aa2262273936
Removing intermediate container aa2262273936
 ---> abea4244c289
Step 4/6 : RUN cd && curl https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.1-linux-x86_64.tar.gz --output elasticsearch-8.1.1-linux-x86_64.tar.gz && tar -xzf elasticsearch-8.1.1-linux-x86_64.tar.gz && rm elasticsearch-8.1.1-linux-x86_64.tar.gz && cd elasticsearch-8.1.1/ && echo "node.name: netology_test" >> config/elasticsearch.yml && echo "path.repo: /var/lib/elastic/snapshots" >> config/elasticsearch.yml
 ---> Running in 5d3532579a8a
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  491M  100  491M    0     0  6431k      0  0:01:18  0:01:18 --:--:-- 7457k
Removing intermediate container 5d3532579a8a
 ---> 3045caa45c5c
Step 5/6 : EXPOSE 9200
 ---> Running in 571a5a32c085
Removing intermediate container 571a5a32c085
 ---> 10beda81146f
Step 6/6 : CMD $HOME/elasticsearch-8.1.1/bin/elasticsearch
 ---> Running in a9a77b995e6d
Removing intermediate container a9a77b995e6d
 ---> b3a682584606
Successfully built b3a682584606
````

* Запустим контейнер с новым образом
````
root@vagrant:/home/vagrant/elasticsearch# docker run -dp 9200:9200 b3a682584606
00ebc6c79712517e17e540ddfe78c44514588a831e5d081ad1c17a448f5ee1d2
````

* Проверим, запустился ли конейнер
````
root@vagrant:/home/vagrant/elasticsearch# docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                                       NAMES
00ebc6c79712   b3a682584606   "/bin/sh -c $HOME/el…"   5 seconds ago   Up 4 seconds   0.0.0.0:9200->9200/tcp, :::9200->9200/tcp   thirsty_hofstadter
````

* Сменим пароль
````
root@vagrant:/home/vagrant/elasticsearch# docker exec -it thirsty_hofstadter /home/elastic/elasticsearch-8.1.1/bin/elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: oQyxm=p4oVXJPesQ+C81
````

* Регистрируем репозиторий `snapshot`ов
````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT "https://127.0.0.1:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'
{
  "type": "fs",
  "settings": {
    "location": "/var/lib/elastic/snapshots"
  }
}
'
Enter host password for user 'elastic':
{
  "acknowledged" : true
}
````

Создайте индекс `test` с 0 реплик и 1 шардом и приведите в ответе список индексов.

* Создание индекса `test`
````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT https://localhost:9200/test -H 'Content-Type: application/json' -d'
> { "settings":
>  { "number_of_replicas": 0,
>    "number_of_shards": 1 }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"test"}
````
* Вывод списка индексов
````
root@vagrant:/home/vagrant# curl -ku elastic -X GET 'https://localhost:9200/_cat/indices?v'
Enter host password for user 'elastic':
health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   test  KUvA6NUqTDiG5Wx069-e3w   1   0          0            0       225b           225b
````

Создайте `snapshot` состояния кластера `elasticsearch`.
````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT https://localhost:9200/_snapshot/netology_backup/elasticsearch?wait_for_completion=true
Enter host password for user 'elastic':
{"snapshot":{"snapshot":"elasticsearch","uuid":"xqVZfEi3QbCW_ABxw39ZtA","repository":"netology_backup","version_id":8010199,"version":"8.1.1","indices":[".security-7",".geoip_databases","test"],"data_streams":[],"include_global_state":true,"state":"SUCCESS","start_time":"2022-04-03T18:26:41.126Z","start_time_in_millis":1649010401126,"end_time":"2022-04-03T18:26:42.328Z","end_time_in_millis":1649010402328,"duration_in_millis":1202,"failures":[],"shards":{"total":3,"failed":0,"successful":3},"feature_states":[{"feature_name":"geoip","indices":[".geoip_databases"]},{"feature_name":"security","indices":[".security-7"]}]}}
````

Приведите в ответе список файлов в директории со `snapshot`ами.
````
root@vagrant:/home/vagrant# docker exec -it thirsty_hofstadter ls -la /var/lib/elastic/snapshots/
total 48
drwxr-xr-x 1 elastic root     4096 Apr  3 18:26 .
drwxr-xr-x 1 root    root     4096 Apr  3 18:05 ..
-rw-r--r-- 1 elastic elastic  1098 Apr  3 18:26 index-0
-rw-r--r-- 1 elastic elastic     8 Apr  3 18:26 index.latest
drwxr-xr-x 5 elastic elastic  4096 Apr  3 18:26 indices
-rw-r--r-- 1 elastic elastic 18464 Apr  3 18:26 meta-xqVZfEi3QbCW_ABxw39ZtA.dat
-rw-r--r-- 1 elastic elastic   392 Apr  3 18:26 snap-xqVZfEi3QbCW_ABxw39ZtA.dat
````

Удалите индекс `test` и создайте индекс `test-2`. Приведите в ответе список индексов.

* Удаление индекса `test`
````
root@vagrant:/home/vagrant# curl -ku elastic -X DELETE 'https://localhost:9200/test?pretty'
Enter host password for user 'elastic':
{
  "acknowledged" : true
}
````

* Создание индекса `test-2` 
````
root@vagrant:/home/vagrant# curl -ku elastic -X PUT https://localhost:9200/test-2 -H 'Content-Type: application/json' -d' { "settings": { "number_of_replicas": 0, "number_of_shards": 1 } } '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"test-2"}
````

* Вывод списка индексов
````
root@vagrant:/home/vagrant# curl -ku elastic -X GET 'https://localhost:9200/_cat/indices?v'
Enter host password for user 'elastic':
health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   test-2 RvB3qjqATYmTyzRPp2I0MA   1   0          0            0       225b           225b
````

Восстановите состояние кластера `elasticsearch` из `snapshot`, созданного ранее.
````
root@vagrant:/home/vagrant# curl -ku elastic -X POST 'https://localhost:9200/test-2/_close?pretty'
Enter host password for user 'elastic':
{
  "acknowledged" : true,
  "shards_acknowledged" : true,
  "indices" : {
    "test-2" : {
      "closed" : true
    }
  }
}

root@vagrant:/home/vagrant# curl -ku elastic -X POST 'https://localhost:9200/_snapshot/netology_backup/elasticsearch/_restore?wait_for_completion=true'
Enter host password for user 'elastic':
{"snapshot":{"snapshot":"elasticsearch","indices":["test"],"shards":{"total":1,"failed":0,"successful":1}}}
````

Приведите в ответе запрос к API восстановления и итоговый список индексов.
````
root@vagrant:/home/vagrant# curl -ku elastic -X GET 'https://localhost:9200/_cat/indices?v'
Enter host password for user 'elastic':
health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  close  test-2 RvB3qjqATYmTyzRPp2I0MA   1   0
green  open   test   i-FMze3rTyyFp85vXFnEEg   1   0          0            0       225b           225b
````